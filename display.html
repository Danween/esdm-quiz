<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tampilan TV - Quiz ESDM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <style>
        :root {
            /* ========================================
               SCALE CONTROL - Ubah nilai ini untuk mengatur ukuran
               Default: 1 (100%)
               Contoh: 0.8 = 80%, 1.2 = 120%, 1.5 = 150%
            ======================================== */
            --scale: 1;
            
            /* Calculated scales - jangan diubah */
            --scale-xs: calc(0.75rem * var(--scale));
            --scale-sm: calc(0.875rem * var(--scale));
            --scale-base: calc(1rem * var(--scale));
            --scale-lg: calc(1.125rem * var(--scale));
            --scale-xl: calc(1.25rem * var(--scale));
            --scale-2xl: calc(1.5rem * var(--scale));
            --scale-3xl: calc(1.875rem * var(--scale));
            --scale-4xl: calc(2.25rem * var(--scale));
            --scale-5xl: calc(3rem * var(--scale));
            --scale-6xl: calc(3.75rem * var(--scale));
            --scale-7xl: calc(4.5rem * var(--scale));
            --scale-8xl: calc(6rem * var(--scale));
            --scale-9xl: calc(8rem * var(--scale));
            
            /* Spacing scales */
            --space-1: calc(0.25rem * var(--scale));
            --space-2: calc(0.5rem * var(--scale));
            --space-3: calc(0.75rem * var(--scale));
            --space-4: calc(1rem * var(--scale));
            --space-5: calc(1.25rem * var(--scale));
            --space-6: calc(1.5rem * var(--scale));
            --space-8: calc(2rem * var(--scale));
            --space-10: calc(2.5rem * var(--scale));
            --space-12: calc(3rem * var(--scale));
            
            /* Icon/element sizes */
            --icon-sm: calc(2rem * var(--scale));
            --icon-md: calc(3rem * var(--scale));
            --icon-lg: calc(4rem * var(--scale));
            --icon-xl: calc(5rem * var(--scale));
            --icon-2xl: calc(6rem * var(--scale));
        }
        
        /* Scalable text classes */
        .text-scaled-xs { font-size: var(--scale-xs); }
        .text-scaled-sm { font-size: var(--scale-sm); }
        .text-scaled-base { font-size: var(--scale-base); }
        .text-scaled-lg { font-size: var(--scale-lg); }
        .text-scaled-xl { font-size: var(--scale-xl); }
        .text-scaled-2xl { font-size: var(--scale-2xl); }
        .text-scaled-3xl { font-size: var(--scale-3xl); }
        .text-scaled-4xl { font-size: var(--scale-4xl); }
        .text-scaled-5xl { font-size: var(--scale-5xl); }
        .text-scaled-6xl { font-size: var(--scale-6xl); }
        .text-scaled-7xl { font-size: var(--scale-7xl); }
        .text-scaled-8xl { font-size: var(--scale-8xl); }
        .text-scaled-9xl { font-size: var(--scale-9xl); }
        
        /* Scalable padding classes */
        .p-scaled-4 { padding: var(--space-4); }
        .p-scaled-5 { padding: var(--space-5); }
        .p-scaled-6 { padding: var(--space-6); }
        .p-scaled-8 { padding: var(--space-8); }
        .p-scaled-12 { padding: var(--space-12); }
        .px-scaled-4 { padding-left: var(--space-4); padding-right: var(--space-4); }
        .py-scaled-2 { padding-top: var(--space-2); padding-bottom: var(--space-2); }
        
        /* Scalable margin classes */
        .mb-scaled-2 { margin-bottom: var(--space-2); }
        .mb-scaled-3 { margin-bottom: var(--space-3); }
        .mb-scaled-4 { margin-bottom: var(--space-4); }
        .mb-scaled-6 { margin-bottom: var(--space-6); }
        .mb-scaled-8 { margin-bottom: var(--space-8); }
        
        /* Scalable gap */
        .gap-scaled-4 { gap: var(--space-4); }
        .space-x-scaled-4 > * + * { margin-left: var(--space-4); }
        
        /* Scalable icons */
        .icon-scaled-sm { width: var(--icon-sm); height: var(--icon-sm); }
        .icon-scaled-md { width: var(--icon-md); height: var(--icon-md); }
        .icon-scaled-lg { width: var(--icon-lg); height: var(--icon-lg); }
        .icon-scaled-xl { width: var(--icon-xl); height: var(--icon-xl); }
        .icon-scaled-2xl { width: var(--icon-2xl); height: var(--icon-2xl); }
        
        /* Scalable border radius */
        .rounded-scaled { border-radius: calc(0.75rem * var(--scale)); }
        .rounded-scaled-xl { border-radius: calc(1rem * var(--scale)); }
        .rounded-scaled-full { border-radius: 9999px; }
        
        /* Scalable heights */
        .h-scaled-3 { height: calc(0.75rem * var(--scale)); }
        
        /* Scale control panel */
        .scale-control {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255,255,255,0.95);
            padding: 12px 16px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .scale-control label {
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }
        .scale-control input[type="range"] {
            width: 120px;
            cursor: pointer;
        }
        .scale-control .scale-value {
            font-weight: bold;
            color: #2563eb;
            min-width: 45px;
            text-align: center;
        }
        .scale-control button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }
        .scale-control button:hover {
            background: #1d4ed8;
        }
    </style>
</head>
<body class="min-h-screen bg-[url('./image/esdm.jpg')] bg-cover bg-center bg-no-repeat">
    <!-- Scale Control Panel -->
    <div class="scale-control" id="scaleControl">
        <label>Scale:</label>
        <input type="range" id="scaleSlider" min="0.5" max="2" step="0.05" value="1">
        <span class="scale-value" id="scaleValue">100%</span>
        <button onclick="resetScale()">Reset</button>
        <button onclick="toggleControlPanel()" title="Sembunyikan">âœ•</button>
    </div>
    
    <!-- Toggle button when panel is hidden -->
    <button id="showScaleBtn" onclick="toggleControlPanel()" 
        class="fixed bottom-5 right-5 bg-blue-600 text-white p-3 rounded-full shadow-lg z-50 hidden hover:bg-blue-700">
        <i class="fas fa-sliders-h"></i>
    </button>

    <div class="min-h-screen grid place-items-center quizesdm">
        <div class="max-w-7xl w-full p-scaled-4">
            <!-- Header -->
            <div class="bg-white/50 backdrop-blur-lg rounded-scaled-xl shadow-xl p-scaled-5 mb-scaled-6 border border-white/30">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-scaled-4">
                        <div class="bg-blue-600 rounded-scaled-full icon-scaled-lg flex items-center justify-center">
                            <i class="fas fa-bolt text-white text-scaled-3xl"></i>
                        </div>
                        <div>
                            <h1 class="text-scaled-3xl font-bold text-white">Quiz ESDM</h1>
                            <p class="text-gray-100 text-scaled-base">Dinas ESDM Provinsi Jambi</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-white text-scaled-base">Peserta:</p>
                        <p class="text-scaled-2xl font-bold text-blue-600" id="participantName">-</p>
                    </div>
                </div>
            </div>

            <!-- Waiting Screen -->
            <div id="waitingScreen" class="text-center">
                <div class="bg-white rounded-scaled-xl shadow-xl p-scaled-12">
                    <i class="fas fa-hourglass-half text-blue-600 text-scaled-7xl mb-scaled-6 animate-pulse"></i>
                    <h2 class="text-scaled-4xl font-bold text-gray-800 mb-scaled-4">Menunggu Quiz Dimulai...</h2>
                    <p class="text-scaled-xl text-gray-600">Silakan scan QR Code untuk bergabung</p>
                </div>
            </div>

            <!-- Question Screen -->
            <div id="questionScreen" class="hidden">
                <!-- Progress and Info -->
                <div class="bg-white/50 backdrop-blur-lg rounded-scaled-xl shadow-xl p-scaled-5 mb-scaled-6 border border-white/30">
                    <div class="flex justify-between items-center mb-scaled-3">
                        <div>
                            <p class="text-white text-scaled-base">Pertanyaan</p>
                            <p class="text-scaled-2xl font-bold text-white">
                                <span id="currentQuestionNum">1</span> / <span id="totalQuestions">10</span>
                            </p>
                        </div>
                        <div class="text-right">
                            <p class="text-white text-scaled-base">Skor Saat Ini</p>
                            <p class="text-scaled-4xl font-bold text-blue-600" id="currentScore">0</p>
                        </div>
                    </div>
                    <div class="bg-gray-200 rounded-full h-scaled-3 overflow-hidden">
                        <div id="progressBar" class="bg-blue-600 h-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Question Card -->
                <div class="bg-white rounded-scaled-xl shadow-xl p-scaled-8 mb-scaled-6">
                    <div class="mb-scaled-6">
                        <div class="inline-block bg-blue-100 text-blue-700 px-scaled-4 py-scaled-2 rounded-full text-scaled-lg font-semibold">
                            <i class="fas fa-question-circle mr-2"></i>
                            Pertanyaan
                        </div>
                    </div>
                    <h2 class="text-scaled-3xl font-bold text-gray-800 mb-scaled-8 leading-tight" id="questionText">-</h2>

                    <!-- Options Grid -->
                    <div class="grid grid-cols-2 gap-scaled-4" id="optionsContainer">
                        <!-- Options will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- Result Screen -->
            <div id="resultScreen" class="hidden">
                <div class="bg-white rounded-scaled-xl shadow-xl p-scaled-12 text-center">
                    <i class="fas fa-trophy text-blue-600 text-scaled-7xl mb-scaled-6"></i>
                    <h2 class="text-scaled-4xl font-bold text-gray-800 mb-scaled-6">Quiz Selesai!</h2>
                    
                    <div class="bg-gradient-to-br from-blue-500 to-blue-700 text-white rounded-scaled-xl p-scaled-8 mb-scaled-6">
                        <p class="text-scaled-2xl mb-scaled-2">Skor Akhir</p>
                        <p class="text-scaled-7xl font-bold" id="finalScore">0</p>
                    </div>

                    <div class="grid grid-cols-3 gap-scaled-4 mb-scaled-6">
                        <div class="bg-blue-50 rounded-scaled-xl p-scaled-4">
                            <p class="text-gray-600 mb-scaled-2 text-scaled-base">Total Soal</p>
                            <p class="text-scaled-3xl font-bold text-blue-600" id="totalQuestionsResult">0</p>
                        </div>
                        <div class="bg-green-50 rounded-scaled-xl p-scaled-4">
                            <p class="text-gray-600 mb-scaled-2 text-scaled-base">Benar</p>
                            <p class="text-scaled-3xl font-bold text-green-600" id="correctAnswers">0</p>
                        </div>
                        <div class="bg-red-50 rounded-scaled-xl p-scaled-4">
                            <p class="text-gray-600 mb-scaled-2 text-scaled-base">Salah</p>
                            <p class="text-scaled-3xl font-bold text-red-600" id="wrongAnswers">0</p>
                        </div>
                    </div>

                    <p class="text-scaled-2xl text-gray-600 mb-scaled-6">Terima kasih telah mengikuti quiz!</p>
                    
                    <button onclick="backToWaiting()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-scaled-xl shadow-lg transition duration-300 text-scaled-xl">
                        <i class="fas fa-home mr-2"></i>
                        Kembali
                    </button>
                </div>
            </div>
        </div>
    </div>    

    <script>
        // Scale Control Functions
        const scaleSlider = document.getElementById('scaleSlider');
        const scaleValue = document.getElementById('scaleValue');
        const scaleControl = document.getElementById('scaleControl');
        const showScaleBtn = document.getElementById('showScaleBtn');
        
        // Load saved scale from localStorage
        const savedScale = localStorage.getItem('quizDisplayScale');
        if (savedScale) {
            document.documentElement.style.setProperty('--scale', savedScale);
            scaleSlider.value = savedScale;
            scaleValue.textContent = Math.round(savedScale * 100) + '%';
        }
        
        // Load panel visibility
        const panelHidden = localStorage.getItem('scaleControlHidden') === 'true';
        if (panelHidden) {
            scaleControl.classList.add('hidden');
            showScaleBtn.classList.remove('hidden');
        }
        
        scaleSlider.addEventListener('input', function() {
            const scale = this.value;
            document.documentElement.style.setProperty('--scale', scale);
            scaleValue.textContent = Math.round(scale * 100) + '%';
            localStorage.setItem('quizDisplayScale', scale);
        });
        
        function resetScale() {
            document.documentElement.style.setProperty('--scale', '1');
            scaleSlider.value = 1;
            scaleValue.textContent = '100%';
            localStorage.setItem('quizDisplayScale', '1');
        }
        
        function toggleControlPanel() {
            const isHidden = scaleControl.classList.toggle('hidden');
            showScaleBtn.classList.toggle('hidden', !isHidden);
            localStorage.setItem('scaleControlHidden', isHidden);
        }
        
        // Keyboard shortcut: Press 'S' to toggle scale control
        document.addEventListener('keydown', function(e) {
            if (e.key === 's' || e.key === 'S') {
                if (!e.ctrlKey && !e.metaKey) { // Don't trigger on Ctrl+S
                    toggleControlPanel();
                }
            }
        });
    </script>

    <script>
        document.addEventListener('keydown', function (e) {
            if (e.key === 'f' || e.key === 'F') {
                e.preventDefault();

                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                } else {
                    document.exitFullscreen();
                }
            }
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="questions.js"></script>
    <script src="app.js"></script>
    <script>
        let activeParticipant = null;
        let currentQuestionIndex = 0;

        const waitingScreen = document.getElementById('waitingScreen');
        const questionScreen = document.getElementById('questionScreen');
        const resultScreen = document.getElementById('resultScreen');

        async function updateDisplay() {
            const activeId = localStorage.getItem('activeParticipantId');
            if (!activeId) {
                showWaitingScreen();
                return;
            }

            try {
                const participant = await QuizApp.getParticipantById(parseInt(activeId));

                if (!participant) {
                    showWaitingScreen();
                    return;
                }

                activeParticipant = participant;
                document.getElementById('participantName').textContent = participant.nama;

                if (participant.status === 'finished') {
                    showResultScreen();
                } else if (participant.status === 'playing' && participant.questions) {
                    showQuestionScreen();
                } else {
                    showWaitingScreen();
                }
            } catch (error) {
                console.error('Error updating display:', error);
                showWaitingScreen();
            }
        }

        function showWaitingScreen() {
            waitingScreen.classList.remove('hidden');
            questionScreen.classList.add('hidden');
            resultScreen.classList.add('hidden');
        }

        function showQuestionScreen() {
            waitingScreen.classList.add('hidden');
            questionScreen.classList.remove('hidden');
            resultScreen.classList.add('hidden');

            if (!activeParticipant || !activeParticipant.questions) return;

            currentQuestionIndex = activeParticipant.currentQuestion || 0;
            const questions = activeParticipant.questions;
            const currentQ = questions[currentQuestionIndex];

            document.getElementById('currentQuestionNum').textContent = currentQuestionIndex + 1;
            document.getElementById('totalQuestions').textContent = questions.length;
            document.getElementById('currentScore').textContent = activeParticipant.score || 0;

            const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';

            document.getElementById('questionText').textContent = currentQ.question;

            // Display options with scaled classes
            const optionsContainer = document.getElementById('optionsContainer');
            const labels = ['A', 'B', 'C', 'D'];
            
            optionsContainer.innerHTML = currentQ.options.map((option, index) => {
                const answer = activeParticipant.answers?.find(a => a.questionIndex === currentQuestionIndex);
                let optionClass = 'bg-gray-50 border-2 border-gray-200';
                let icon = '';

                if (answer) {
                    if (index === currentQ.correct) {
                        optionClass = 'bg-green-100 border-2 border-green-500';
                        icon = '<i class="fas fa-check-circle text-green-500 text-scaled-3xl"></i>';
                    } else if (index === answer.selected && !answer.isCorrect) {
                        optionClass = 'bg-red-100 border-2 border-red-500';
                        icon = '<i class="fas fa-times-circle text-red-500 text-scaled-3xl"></i>';
                    }
                }

                return `
                    <div class="${optionClass} rounded-scaled-xl p-scaled-5 transition-all duration-300">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-scaled-4">
                                <div class="bg-blue-600 text-white icon-scaled-md rounded-scaled-full flex items-center justify-center text-scaled-xl font-bold flex-shrink-0">
                                    ${labels[index]}
                                </div>
                                <p class="text-scaled-xl font-semibold text-gray-800">${option}</p>
                            </div>
                            <div>
                                ${icon}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showResultScreen() {
            waitingScreen.classList.add('hidden');
            questionScreen.classList.add('hidden');
            resultScreen.classList.remove('hidden');

            if (!activeParticipant) return;

            const totalQuestions = activeParticipant.questions?.length || 0;
            const score = activeParticipant.score || 0;
            const wrong = totalQuestions - score;

            document.getElementById('finalScore').textContent = score;
            document.getElementById('totalQuestionsResult').textContent = totalQuestions;
            document.getElementById('correctAnswers').textContent = score;
            document.getElementById('wrongAnswers').textContent = wrong;
        }

        function backToWaiting() {
            localStorage.removeItem('activeParticipantId');
            updateDisplay();
        }

        // Supabase Realtime listener
        const activeId = localStorage.getItem('activeParticipantId');
        if (activeId) {
            const displayChannel = supabaseClient
                .channel(`display-${activeId}`)
                .on('postgres_changes', 
                    { 
                        event: 'UPDATE', 
                        schema: 'public', 
                        table: 'participants',
                        filter: `id=eq.${activeId}`
                    },
                    async (payload) => {
                        console.log('Display updated:', payload);
                        await updateDisplay();
                    }
                )
                .subscribe();

            window.addEventListener('beforeunload', () => {
                supabaseClient.removeChannel(displayChannel);
            });
        }

        // Auto update every 2 seconds (backup)
        setInterval(updateDisplay, 2000);

        // Initial load
        updateDisplay();

        // Listen to storage events for activeParticipantId changes
        window.addEventListener('storage', (e) => {
            if (e.key === 'activeParticipantId') {
                location.reload();
            }
        });
    </script>
</body>
</html>
